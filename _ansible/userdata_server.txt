#cloud-config
runcmd:
  - sudo sed -i '$ a nameserver 8.8.8.8' /etc/resolv.conf
  - sudo apt-get update
  - sudo apt update
  - echo "Installing apache2 server..."
  - sudo apt install -y apache2
  - echo "Installing and configuring php..."
  - sudo apt install -y php libapache2-mod-php php-mysql
  - sudo apt install -y php-curl php-json php-gd php7.2-xml
  - sudo apt install -y mysql-client-core-5.7 
  - sudo a2enmod rewrite expires
  - sudo systemctl restart apache2
  - echo "Installing zip ..."
  - sudo apt install -y zip 
  - echo "Installing ffmpeg..."
  - sudo apt install -y ffmpeg
  - echo "Reloading apache2..."
  - sudo systemctl reload apache2.service  
  - echo "Downloading ampache 4.4.2 ... "
  - wget https://github.com/ampache/ampache/releases/download/4.4.2/ampache-4.4.2_all.zip
  - echo "Unzipping ampache ..."
  - sudo unzip ampache-4.4.2_all.zip -d /var/www/html/
  - sudo chown --recursive www-data:www-data /var/www/html
  - echo "Renaming some files ..."
  - sudo mv /var/www/html/rest/.htaccess.dist /var/www/html/rest/.htaccess
  - sudo mv /var/www/html/play/.htaccess.dist /var/www/html/play/.htaccess
  - sudo mv /var/www/html/channel/.htaccess.dist /var/www/html/channel/.htaccess
  - sudo apt-get install -y nfs-common 
  - sudo mkdir -p /mnt/sharedMusic
  - sudo ip route add 10.10.30.0/24 via 10.10.20.3
  - sudo touch /etc/apache2/httpd.conf
  - sudo echo "# ServerName gives the name and port that the server uses to identify itself." | sudo tee /etc/apache2/httpd.conf > /dev/null
  - sudo sed -i "$ a # This can often be determined automatically, but we recommend you specify" /etc/apache2/httpd.conf
  - sudo sed -i "$ a # it explicitly to prevent problems during startup." /etc/apache2/httpd.conf
  - sudo sed -i "$ a #" /etc/apache2/httpd.conf
  - sudo sed -i "$ a # If your host doesn't have a registered DNS name, enter its IP address here." /etc/apache2/httpd.conf
  - sudo sed -i "$ a ServerName 127.0.0.1:80" /etc/apache2/httpd.conf
  - sudo sed -i "$ a Include /etc/apache2/httpd.conf" /etc/apache2/apache2.conf
  - sudo systemctl restart apache2

